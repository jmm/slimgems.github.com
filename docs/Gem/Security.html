<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Gem::Security
  
    &mdash; Documentation by YARD 0.6.8
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (S)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Gem.html" title="Gem (module)">Gem</a></span></span>
     &raquo; 
    <span class="title">Security</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: Gem::Security
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/rubygems/security.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <h1>Signed Gems README</h1>
<h2>Table of Contents</h2>
<ul>
<li><p>
Overview
</p>
</li>
<li><p>
Walkthrough
</p>
</li>
<li><p>
Command-Line Options
</p>
</li>
<li><p>
OpenSSL Reference
</p>
</li>
<li><p>
Bugs/TODO
</p>
</li>
<li><p>
About the Author
</p>
</li>
</ul>
<h2>Overview</h2>
<p>
Gem::Security implements cryptographic signatures in RubyGems.  The section
below is a step-by-step guide to using signed gems and generating your own.
</p>
<h2>Walkthrough</h2>
<p>
In order to start signing your gems, you&#8217;ll need to build a private
key and a self-signed certificate.  Here&#8217;s how:
</p>
<pre class="code">
  # build a private key and certificate for gemmaster@example.com
  $ gem cert --build gemmaster@example.com
</pre>
<p>
This could take anywhere from 5 seconds to 10 minutes, depending on the
speed of your computer (public key algorithms aren&#8217;t exactly the
speediest crypto algorithms in the world).  When it&#8217;s finished,
you&#8217;ll see the files &#8220;gem-private_key.pem&#8221; and
&#8220;gem-public_cert.pem&#8221; in the current directory.
</p>
<p>
First things first: take the &#8220;gem-private_key.pem&#8221; file and
move it somewhere private, preferably a directory only you have access to,
a floppy (yuck!), a CD-ROM, or something comparably secure.  Keep your
private key hidden; if it&#8217;s compromised, someone can sign packages as
you (note: PKI has ways of mitigating the risk of stolen keys; more on that
later).
</p>
<p>
Now, let&#8217;s sign an existing gem.  I&#8217;ll be using my Imlib2-Ruby
bindings, but you can use whatever gem you&#8217;d like.  Open up your
existing gemspec file and add the following lines:
</p>
<pre class="code">
  <span class='comment'># signing key and certificate chain
</span>  <span class='id s'>s</span><span class='period'>.</span><span class='id signing_key'>signing_key</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/mnt/floppy/gem-private_key.pem</span><span class='tstring_end'>'</span></span>
  <span class='id s'>s</span><span class='period'>.</span><span class='id cert_chain'>cert_chain</span>  <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>gem-public_cert.pem</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
</pre>
<p>
(Be sure to replace &#8220;/mnt/floppy&#8221; with the ultra-secret path to
your private key).
</p>
<p>
After that, go ahead and build your gem as usual.  Congratulations,
you&#8217;ve just built your first signed gem!  If you peek inside your gem
file, you&#8217;ll see a couple of new files have been added:
</p>
<pre class="code">
  $ tar tf tar tf Imlib2-Ruby-0.5.0.gem
  data.tar.gz
  data.tar.gz.sig
  metadata.gz
  metadata.gz.sig
</pre>
<p>
Now let&#8217;s verify the signature.  Go ahead and install the gem, but
add the following options: &#8220;-P HighSecurity&#8221;, like this:
</p>
<pre class="code">
  # install the gem with using the security policy &quot;HighSecurity&quot;
  $ sudo gem install Imlib2-Ruby-0.5.0.gem -P HighSecurity
</pre>
<p>
The -P option sets your security policy &#8212; we&#8217;ll talk about that
in just a minute.  Eh, what&#8217;s this?
</p>
<pre class="code">
  Attempting local installation of 'Imlib2-Ruby-0.5.0.gem'
  ERROR:  Error installing gem Imlib2-Ruby-0.5.0.gem[.gem]: Couldn't
  verify data signature: Untrusted Signing Chain Root: cert =
  '/CN=gemmaster/DC=example/DC=com', error = 'path
  &quot;/root/.rubygems/trust/cert-15dbb43a6edf6a70a85d4e784e2e45312cff7030.pem&quot;
  does not exist'
</pre>
<p>
The culprit here is the security policy.  RubyGems has several different
security policies.  Let&#8217;s take a short break and go over the security
policies.  Here&#8217;s a list of the available security policies, and a
brief description of each one:
</p>
<ul>
<li><p>
NoSecurity - Well, no security at all.  Signed packages are treated like
unsigned packages.
</p>
</li>
<li><p>
LowSecurity - Pretty much no security.  If a package is signed then
RubyGems will make sure the signature matches the signing certificate, and
that the signing certificate hasn&#8217;t expired, but that&#8217;s it.  A
malicious user could easily circumvent this kind of security.
</p>
</li>
<li><p>
MediumSecurity - Better than LowSecurity and NoSecurity, but still
fallible.  Package contents are verified against the signing certificate,
and the signing certificate is checked for validity, and checked against
the rest of the certificate chain (if you don&#8217;t know what a
certificate chain is, stay tuned, we&#8217;ll get to that). The biggest
improvement over LowSecurity is that MediumSecurity won&#8217;t install
packages that are signed by untrusted sources. Unfortunately,
MediumSecurity still isn&#8217;t totally secure &#8212; a malicious user
can still unpack the gem, strip the signatures, and distribute the gem
unsigned.
</p>
</li>
<li><p>
HighSecurity - Here&#8217;s the bugger that got us into this mess. The
HighSecurity policy is identical to the MediumSecurity policy, except that
it does not allow unsigned gems.  A malicious user doesn&#8217;t have a
whole lot of options here; he can&#8217;t modify the package contents
without invalidating the signature, and he can&#8217;t modify or remove
signature or the signing certificate chain, or RubyGems will simply refuse
to install the package.  Oh well, maybe he&#8217;ll have better luck
causing problems for CPAN users instead :).
</p>
</li>
</ul>
<p>
So, the reason RubyGems refused to install our shiny new signed gem was
because it was from an untrusted source.  Well, my code is infallible
(hah!), so I&#8217;m going to add myself as a trusted source.
</p>
<p>
Here&#8217;s how:
</p>
<pre class="code">
    # add trusted certificate
    gem cert --add gem-public_cert.pem
</pre>
<p>
I&#8217;ve added my public certificate as a trusted source.  Now I can
install packages signed my private key without any hassle.  Let&#8217;s try
the install command above again:
</p>
<pre class="code">
  # install the gem with using the HighSecurity policy (and this time
  # without any shenanigans)
  $ sudo gem install Imlib2-Ruby-0.5.0.gem -P HighSecurity
</pre>
<p>
This time RubyGems should accept your signed package and begin installing.
While you&#8217;re waiting for RubyGems to work it&#8217;s magic, have a
look at some of the other security commands:
</p>
<pre class="code">
  Usage: gem cert [options]

  Options:
    -a, --add CERT          Add a trusted certificate.
    -l, --list              List trusted certificates.
    -r, --remove STRING     Remove trusted certificates containing STRING.
    -b, --build EMAIL_ADDR  Build private key and self-signed certificate
                            for EMAIL_ADDR.
    -C, --certificate CERT  Certificate for --sign command.
    -K, --private-key KEY   Private key for --sign command.
    -s, --sign NEWCERT      Sign a certificate with my key and certificate.
</pre>
<p>
(By the way, you can pull up this list any time you&#8217;d like by typing
&#8220;gem cert --help&#8221;)
</p>
<p>
Hmm.  We&#8217;ve already covered the &#8220;--build&#8221; option,
and the &#8220;--add&#8221;, &#8220;--list&#8221;, and
&#8220;--remove&#8221; commands seem fairly straightforward; they
allow you to add, list, and remove the certificates in your trusted
certificate list.  But what&#8217;s with this &#8220;--sign&#8221;
option?
</p>
<p>
To answer that question, let&#8217;s take a look at &#8220;certificate
chains&#8221;, a concept I mentioned earlier.  There are a couple of
problems with self-signed certificates: first of all, self-signed
certificates don&#8217;t offer a whole lot of security.  Sure, the
certificate says Yukihiro Matsumoto, but how do I know it was actually
generated and signed by matz himself unless he gave me the certificate in
person?
</p>
<p>
The second problem is scalability.  Sure, if there are 50 gem authors, then
I have 50 trusted certificates, no problem.  What if there are 500 gem
authors?  1000?  Having to constantly add new trusted certificates is a
pain, and it actually makes the trust system less secure by encouraging
RubyGems users to blindly trust new certificates.
</p>
<p>
Here&#8217;s where certificate chains come in.  A certificate chain
establishes an arbitrarily long chain of trust between an issuing
certificate and a child certificate.  So instead of trusting certificates
on a per-developer basis, we use the PKI concept of certificate chains to
build a logical hierarchy of trust.  Here&#8217;s a hypothetical example of
a trust hierarchy based (roughly) on geography:
</p>
<pre class="code">
                        --------------------------
                        | rubygems@rubyforge.org |
                        --------------------------
                                    |
                  -----------------------------------
                  |                                 |
      ----------------------------    -----------------------------
      | seattle.rb@zenspider.com |    | dcrubyists@richkilmer.com |
      ----------------------------    -----------------------------
           |                |                 |             |
    ---------------   ----------------   -----------   --------------
    | alf@seattle |   | bob@portland |   | pabs@dc |   | tomcope@dc |
    ---------------   ----------------   -----------   --------------
</pre>
<p>
Now, rather than having 4 trusted certificates (one for alf@seattle,
bob@portland, pabs@dc, and tomecope@dc), a user could actually get by with
1 certificate: the &#8220;rubygems@rubyforge.org&#8221; certificate. 
Here&#8217;s how it works:
</p>
<p>
I install &#8220;Alf2000-Ruby-0.1.0.gem&#8221;, a package signed by
&#8220;alf@seattle&#8221;.  I&#8217;ve never heard of
&#8220;alf@seattle&#8221;, but his certificate has a valid signature from
the &#8220;seattle.rb@zenspider.com&#8221; certificate, which in turn has a
valid signature from the &#8220;rubygems@rubyforge.org&#8221; certificate. 
Voila!  At this point, it&#8217;s much more reasonable for me to trust a
package signed by &#8220;alf@seattle&#8221;, because I can establish a
chain to &#8220;rubygems@rubyforge.org&#8221;, which I do trust.
</p>
<p>
And the &#8220;--sign&#8221; option allows all this to happen.  A
developer creates their build certificate with the
&#8220;--build&#8221; option, then has their certificate signed by
taking it with them to their next regional Ruby meetup (in our hypothetical
example), and it&#8217;s signed there by the person holding the regional
RubyGems signing certificate, which is signed at the next RubyConf by the
holder of the top-level RubyGems certificate.  At each point the issuer
runs the same command:
</p>
<pre class="code">
  # sign a certificate with the specified key and certificate
  # (note that this modifies client_cert.pem!)
  $ gem cert -K /mnt/floppy/issuer-priv_key.pem -C issuer-pub_cert.pem
     --sign client_cert.pem
</pre>
<p>
Then the holder of issued certificate (in this case, our buddy
&#8220;alf@seattle&#8221;), can start using this signed certificate to sign
RubyGems. By the way, in order to let everyone else know about his new
fancy signed certificate, &#8220;alf@seattle&#8221; would change his
gemspec file to look like this:
</p>
<pre class="code">
  <span class='comment'># signing key (still kept in an undisclosed location!)
</span>  <span class='id s'>s</span><span class='period'>.</span><span class='id signing_key'>signing_key</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/mnt/floppy/alf-private_key.pem</span><span class='tstring_end'>'</span></span>

  <span class='comment'># certificate chain (includes the issuer certificate now too)
</span>  <span class='id s'>s</span><span class='period'>.</span><span class='id cert_chain'>cert_chain</span>  <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/home/alf/doc/seattlerb-public_cert.pem</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
                   <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/home/alf/doc/alf_at_seattle-public_cert.pem</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
</pre>
<p>
Obviously, this RubyGems trust infrastructure doesn&#8217;t exist yet. 
Also, in the &#8220;real world&#8221; issuers actually generate the child
certificate from a certificate request, rather than sign an existing
certificate.  And our hypothetical infrastructure is missing a certificate
revocation system. These are that can be fixed in the future&#8230;
</p>
<p>
I&#8217;m sure your new signed gem has finished installing by now (unless
you&#8217;re installing rails and all it&#8217;s dependencies, that is ;D).
At this point you should know how to do all of these new and interesting
things:
</p>
<ul>
<li><p>
build a gem signing key and certificate
</p>
</li>
<li><p>
modify your existing gems to support signing
</p>
</li>
<li><p>
adjust your security policy
</p>
</li>
<li><p>
modify your trusted certificate list
</p>
</li>
<li><p>
sign a certificate
</p>
</li>
</ul>
<p>
If you&#8217;ve got any questions, feel free to contact me at the email
address below.  The next couple of sections
</p>
<h2>Command-Line Options</h2>
<p>
Here&#8217;s a brief summary of the certificate-related command line
options:
</p>
<pre class="code">
  gem install
    -P, --trust-policy POLICY        Specify gem trust policy.

  gem cert
    -a, --add CERT                   Add a trusted certificate.
    -l, --list                       List trusted certificates.
    -r, --remove STRING              Remove trusted certificates containing
                                     STRING.
    -b, --build EMAIL_ADDR           Build private key and self-signed
                                     certificate for EMAIL_ADDR.
    -C, --certificate CERT           Certificate for --sign command.
    -K, --private-key KEY            Private key for --sign command.
    -s, --sign NEWCERT               Sign a certificate with my key and
                                     certificate.
</pre>
<p>
A more detailed description of each options is available in the walkthrough
above.
</p>
<h2>Manually verifying signatures</h2>
<p>
In case you don&#8217;t trust RubyGems you can verify gem signatures
manually:
</p>
<ol>
<li><p>
Fetch and unpack the gem
</p>
<pre class="code">
 gem fetch some_signed_gem
 tar -xf some_signed_gem-1.0.gem
</pre>
</li>
<li><p>
Grab the public key from the gemspec
</p>
<pre class="code">
 gem spec some_signed_gem-1.0.gem cert_chain | \
   ruby -pe 'sub(/^ +/, &quot;&quot;)' &gt; public_key.crt
</pre>
</li>
<li><p>
Generate a SHA1 hash of the data.tar.gz
</p>
<pre class="code">
 <span class='id openssl'>openssl</span> <span class='id dgst'>dgst</span> <span class='op'>-</span><span class='id sha1'>sha1</span> <span class='op'>&lt;</span> <span class='id data'>data</span><span class='period'>.</span><span class='id tar'>tar</span><span class='period'>.</span><span class='id gz'>gz</span> <span class='op'>&gt;</span> <span class='id my'>my</span><span class='period'>.</span><span class='id hash'>hash</span>
</pre>
</li>
<li><p>
Verify the signature
</p>
<pre class="code">
 openssl rsautl -verify -inkey public_key.crt -certin \
   -in data.tar.gz.sig &gt; verified.hash
</pre>
</li>
<li><p>
Compare your hash to the verified hash
</p>
<pre class="code">
 diff -s verified.hash my.hash
</pre>
</li>
<li><p>
Repeat 5 and 6 with metadata.gz
</p>
</li>
</ol>
<h2>OpenSSL Reference</h2>
<p>
The .pem files generated by --build and --sign are just basic
OpenSSL PEM files.  Here&#8217;s a couple of useful commands for
manipulating them:
</p>
<pre class="code">
  # convert a PEM format X509 certificate into DER format:
  # (note: Windows .cer files are X509 certificates in DER format)
  $ openssl x509 -in input.pem -outform der -out output.der

  # print out the certificate in a human-readable format:
  $ openssl x509 -in input.pem -noout -text
</pre>
<p>
And you can do the same thing with the private key file as well:
</p>
<pre class="code">
  # convert a PEM format RSA key into DER format:
  $ openssl rsa -in input_key.pem -outform der -out output_key.der

  # print out the key in a human readable format:
  $ openssl rsa -in input_key.pem -noout -text
</pre>
<h2>Bugs/TODO</h2>
<ul>
<li><p>
There&#8217;s no way to define a system-wide trust list.
</p>
</li>
<li><p>
custom security policies (from a YAML file, etc)
</p>
</li>
<li><p>
Simple method to generate a signed certificate request
</p>
</li>
<li><p>
Support for OCSP, SCVP, CRLs, or some other form of cert status check (list
is in order of preference)
</p>
</li>
<li><p>
Support for encrypted private keys
</p>
</li>
<li><p>
Some sort of semi-formal trust hierarchy (see long-winded explanation
above)
</p>
</li>
<li><p>
Path discovery (for gem certificate chains that don&#8217;t have a
self-signed root) &#8212; by the way, since we don&#8217;t have this, THE
ROOT OF THE CERTIFICATE CHAIN MUST BE SELF SIGNED if Policy#verify_root is
true (and it is for the MediumSecurity and HighSecurity policies)
</p>
</li>
<li><p>
Better explanation of X509 naming (ie, we don&#8217;t have to use email
addresses)
</p>
</li>
<li><p>
Possible alternate signing mechanisms (eg, via PGP).  this could be done
pretty easily by adding a :signing_type attribute to the gemspec, then add
the necessary support in other places
</p>
</li>
<li><p>
Honor AIA field (see note about OCSP above)
</p>
</li>
<li><p>
Maybe honor restriction extensions?
</p>
</li>
<li><p>
Might be better to store the certificate chain as a PKCS#7 or PKCS#12 file,
instead of an array embedded in the metadata.  ideas?
</p>
</li>
<li><p>
Possibly embed signature and key algorithms into metadata (right now
they&#8217;re assumed to be the same as what&#8217;s set in
Gem::Security::OPT)
</p>
</li>
</ul>
<h2>About the Author</h2>
<p>
Paul Duncan <pabs@pablotron.org> <a
href="http://pablotron.org">pablotron.org</a>/
</p>


  </div>
</div>
<div class="tags">
  
</div><h2>Defined Under Namespace</h2>
<p class="children">
   
    
   
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Security/Exception.html" title="Gem::Security::Exception (class)">Exception</a></span>, <span class='object_link'><a href="Security/Policy.html" title="Gem::Security::Policy (class)">Policy</a></span>, <span class='object_link'><a href="Security/Signer.html" title="Gem::Security::Signer (class)">Signer</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="OPT-constant" class="">OPT =
          <div class="docstring">
  <div class="discussion">
    <p>
default options for most of the methods below
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='comment'># private key options
</span>  <span class='symbol'>:key_algo</span>   <span class='op'>=&gt;</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>PKEY_RSA</span><span class='comma'>,</span>
  <span class='symbol'>:key_size</span>   <span class='op'>=&gt;</span> <span class='int'>2048</span><span class='comma'>,</span>

  <span class='comment'># public cert options
</span>  <span class='symbol'>:cert_age</span>   <span class='op'>=&gt;</span> <span class='int'>365</span> <span class='op'>*</span> <span class='int'>24</span> <span class='op'>*</span> <span class='int'>3600</span><span class='comma'>,</span> <span class='comment'># 1 year
</span>  <span class='symbol'>:dgst_algo</span>  <span class='op'>=&gt;</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>DIGEST_SHA1</span><span class='comma'>,</span>

  <span class='comment'># x509 certificate extensions
</span>  <span class='symbol'>:cert_exts</span>  <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>basicConstraints</span><span class='tstring_end'>'</span></span>      <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>CA:FALSE</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>subjectKeyIdentifier</span><span class='tstring_end'>'</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>hash</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>keyUsage</span><span class='tstring_end'>'</span></span>              <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>keyEncipherment,dataEncipherment,digitalSignature</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
  <span class='rbrace'>}</span><span class='comma'>,</span>

  <span class='comment'># save the key and cert to a file in build_self_signed_cert()?
</span>  <span class='symbol'>:save_key</span>   <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:save_cert</span>  <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>

  <span class='comment'># if you define either of these, then they'll be used instead of
</span>  <span class='comment'># the output_fmt macro below
</span>  <span class='symbol'>:save_key_path</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span>
  <span class='symbol'>:save_cert_path</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span>

  <span class='comment'># output name format for self-signed certs
</span>  <span class='symbol'>:output_fmt</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>gem-%s.pem</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
  <span class='symbol'>:munge_re</span>   <span class='op'>=&gt;</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^a-z0-9_.-]+</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='comma'>,</span>

  <span class='comment'># output directory for trusted certificate checksums
</span>  <span class='symbol'>:trust_dir</span> <span class='op'>=&gt;</span> <span class='const'>File</span><span class='op'>::</span><span class='id join'>join</span><span class='lparen'>(</span><span class='const'>Gem</span><span class='period'>.</span><span class='id user_home'>user_home</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>.gem</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>trust</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='comma'>,</span>

  <span class='comment'># default permissions for trust directory and certs
</span>  <span class='symbol'>:perms</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
    <span class='symbol'>:trust_dir</span>      <span class='op'>=&gt;</span> <span class='int'>0700</span><span class='comma'>,</span>
    <span class='symbol'>:trusted_cert</span>   <span class='op'>=&gt;</span> <span class='int'>0600</span><span class='comma'>,</span>
    <span class='symbol'>:signing_cert</span>   <span class='op'>=&gt;</span> <span class='int'>0600</span><span class='comma'>,</span>
    <span class='symbol'>:signing_key</span>    <span class='op'>=&gt;</span> <span class='int'>0600</span><span class='comma'>,</span>
  <span class='rbrace'>}</span><span class='comma'>,</span>
<span class='rbrace'>}</span></pre></dd>
      
        <dt id="NoSecurity-constant" class="">NoSecurity =
          <div class="docstring">
  <div class="discussion">
    <p>
No security policy: all package signature checks are disabled.
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="AlmostNoSecurity-constant" class="">AlmostNoSecurity =
          <div class="docstring">
  <div class="discussion">
    <p>
AlmostNo security policy: only verify that the signing certificate is the
one that actually signed the data.  Make no attempt to verify the signing
certificate chain.
</p>
<p>
This policy is basically useless. better than nothing, but can still be
easily spoofed, and is not recommended.
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="LowSecurity-constant" class="">LowSecurity =
          <div class="docstring">
  <div class="discussion">
    <p>
Low security policy: only verify that the signing certificate is actually
the gem signer, and that the signing certificate is valid.
</p>
<p>
This policy is better than nothing, but can still be easily spoofed, and is
not recommended.
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="MediumSecurity-constant" class="">MediumSecurity =
          <div class="docstring">
  <div class="discussion">
    <p>
Medium security policy: verify the signing certificate, verify the signing
certificate chain all the way to the root certificate, and only trust root
certificates that we have explicitly allowed trust for.
</p>
<p>
This security policy is reasonable, but it allows unsigned packages, so a
malicious person could simply delete the package signature and pass the gem
off as unsigned.
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="HighSecurity-constant" class="">HighSecurity =
          <div class="docstring">
  <div class="discussion">
    <p>
High security policy: only allow signed gems to be installed, verify the
signing certificate, verify the signing certificate chain all the way to
the root certificate, and only trust root certificates that we have
explicitly allowed trust for.
</p>
<p>
This security policy is significantly more difficult to bypass, and offers
a reasonable guarantee that the contents of the gem have not been altered.
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="Policies-constant" class="">Policies =
          <div class="docstring">
  <div class="discussion">
    <p>
Hash of configured security policies
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>NoSecurity</span><span class='tstring_end'>'</span></span>       <span class='op'>=&gt;</span> <span class='const'>NoSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>AlmostNoSecurity</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='const'>AlmostNoSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>LowSecurity</span><span class='tstring_end'>'</span></span>      <span class='op'>=&gt;</span> <span class='const'>LowSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>MediumSecurity</span><span class='tstring_end'>'</span></span>   <span class='op'>=&gt;</span> <span class='const'>MediumSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>HighSecurity</span><span class='tstring_end'>'</span></span>     <span class='op'>=&gt;</span> <span class='const'>HighSecurity</span><span class='comma'>,</span>
<span class='rbrace'>}</span></pre></dd>
      
    </dl>
  





  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_trusted_cert-class_method" title="add_trusted_cert (class method)">+ (Object) <strong>add_trusted_cert</strong>(cert, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Add certificate to trusted cert list.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_cert-class_method" title="build_cert (class method)">+ (Object) <strong>build_cert</strong>(name, key, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Build a certificate from the given DN and private key.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_self_signed_cert-class_method" title="build_self_signed_cert (class method)">+ (Object) <strong>build_self_signed_cert</strong>(email_addr, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Build a self-signed certificate for the given email address.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sign_cert-class_method" title="sign_cert (class method)">+ (Object) <strong>sign_cert</strong>(cert, signing_key, signing_cert, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sign the cert cert with @signing_key and @signing_cert, using the digest
algorithm opt[:dgst_algo].
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#verify_trust_dir-class_method" title="verify_trust_dir (class method)">+ (Object) <strong>verify_trust_dir</strong>(path, perms) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Make sure the trust directory exists.
</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="add_trusted_cert-class_method">
  
    + (<tt>Object</tt>) <strong>add_trusted_cert</strong>(cert, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Add certificate to trusted cert list.
</p>
<p>
Note: At the moment these are stored in OPT[:trust_dir], although that
directory may change in the future.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 755</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id add_trusted_cert'>add_trusted_cert</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># get destination path
</span>  <span class='id path'>path</span> <span class='op'>=</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>Security</span><span class='op'>::</span><span class='const'>Policy</span><span class='period'>.</span><span class='id trusted_cert_path'>trusted_cert_path</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># verify trust directory (can't write to nowhere, you know)
</span>  <span class='id verify_trust_dir'>verify_trust_dir</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># write cert to output file
</span>  <span class='const'>File</span><span class='period'>.</span><span class='id open'>open</span><span class='lparen'>(</span><span class='id path'>path</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wb</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id file'>file</span><span class='op'>|</span>
    <span class='id file'>file</span><span class='period'>.</span><span class='id chmod'>chmod</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:trusted_cert</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id file'>file</span><span class='period'>.</span><span class='id write'>write</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='period'>.</span><span class='id to_pem'>to_pem</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># return nil
</span>  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="build_cert-class_method">
  
    + (<tt>Object</tt>) <strong>build_cert</strong>(name, key, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Build a certificate from the given DN and private key.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 670</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id build_cert'>build_cert</span><span class='lparen'>(</span><span class='id name'>name</span><span class='comma'>,</span> <span class='id key'>key</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='const'>Gem</span><span class='period'>.</span><span class='id ensure_ssl_available'>ensure_ssl_available</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># create new cert
</span>  <span class='id ret'>ret</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>X509</span><span class='op'>::</span><span class='const'>Certificate</span><span class='period'>.</span><span class='id new'>new</span>

  <span class='comment'># populate cert attributes
</span>  <span class='id ret'>ret</span><span class='period'>.</span><span class='id version'>version</span> <span class='op'>=</span> <span class='int'>2</span>
  <span class='id ret'>ret</span><span class='period'>.</span><span class='id serial'>serial</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id ret'>ret</span><span class='period'>.</span><span class='id public_key'>public_key</span> <span class='op'>=</span> <span class='id key'>key</span><span class='period'>.</span><span class='id public_key'>public_key</span>
  <span class='id ret'>ret</span><span class='period'>.</span><span class='id not_before'>not_before</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span>
  <span class='id ret'>ret</span><span class='period'>.</span><span class='id not_after'>not_after</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span> <span class='op'>+</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:cert_age</span><span class='rbracket'>]</span>
  <span class='id ret'>ret</span><span class='period'>.</span><span class='id subject'>subject</span> <span class='op'>=</span> <span class='id name'>name</span>

  <span class='comment'># add certificate extensions
</span>  <span class='id ef'>ef</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>X509</span><span class='op'>::</span><span class='const'>ExtensionFactory</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id ret'>ret</span><span class='rparen'>)</span>
  <span class='id ret'>ret</span><span class='period'>.</span><span class='id extensions'>extensions</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:cert_exts</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id k'>k</span><span class='comma'>,</span> <span class='id v'>v</span><span class='op'>|</span> <span class='id ef'>ef</span><span class='period'>.</span><span class='id create_extension'>create_extension</span><span class='lparen'>(</span><span class='id k'>k</span><span class='comma'>,</span> <span class='id v'>v</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

  <span class='comment'># sign cert
</span>  <span class='id i_key'>i_key</span><span class='comma'>,</span> <span class='id i_cert'>i_cert</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:issuer_key</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id key'>key</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:issuer_cert</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id ret'>ret</span>
  <span class='id ret'>ret</span> <span class='op'>=</span> <span class='id sign_cert'>sign_cert</span><span class='lparen'>(</span><span class='id ret'>ret</span><span class='comma'>,</span> <span class='id i_key'>i_key</span><span class='comma'>,</span> <span class='id i_cert'>i_cert</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># return cert
</span>  <span class='id ret'>ret</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="build_self_signed_cert-class_method">
  
    + (<tt>Object</tt>) <strong>build_self_signed_cert</strong>(email_addr, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Build a self-signed certificate for the given email address.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 700</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id build_self_signed_cert'>build_self_signed_cert</span><span class='lparen'>(</span><span class='id email_addr'>email_addr</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='const'>Gem</span><span class='period'>.</span><span class='id ensure_ssl_available'>ensure_ssl_available</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='rparen'>)</span>
  <span class='id path'>path</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:key</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='symbol'>:cert</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span> <span class='rbrace'>}</span>

  <span class='comment'># split email address up
</span>  <span class='id cn'>cn</span><span class='comma'>,</span> <span class='id dcs'>dcs</span> <span class='op'>=</span> <span class='id email_addr'>email_addr</span><span class='period'>.</span><span class='id split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>@</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='id dcs'>dcs</span> <span class='op'>=</span> <span class='id dcs'>dcs</span><span class='period'>.</span><span class='id split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>.</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>

  <span class='comment'># munge email CN and DCs
</span>  <span class='id cn'>cn</span> <span class='op'>=</span> <span class='id cn'>cn</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:munge_re</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='id dcs'>dcs</span> <span class='op'>=</span> <span class='id dcs'>dcs</span><span class='period'>.</span><span class='id map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id dc'>dc</span><span class='op'>|</span> <span class='id dc'>dc</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:munge_re</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>

  <span class='comment'># create DN
</span>  <span class='id name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CN=</span><span class='embexpr_beg'>#{</span><span class='id cn'>cn</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id dcs'>dcs</span><span class='period'>.</span><span class='id map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id dc'>dc</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DC=</span><span class='embexpr_beg'>#{</span><span class='id dc'>dc</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='id name'>name</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>X509</span><span class='op'>::</span><span class='const'>Name</span><span class='op'>::</span><span class='id parse'>parse</span><span class='lparen'>(</span><span class='id name'>name</span><span class='rparen'>)</span>

  <span class='comment'># build private key
</span>  <span class='id key'>key</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:key_algo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:key_size</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># method name pretty much says it all :)
</span>  <span class='id verify_trust_dir'>verify_trust_dir</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># if we're saving the key, then write it out
</span>  <span class='kw'>if</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_key</span><span class='rbracket'>]</span>
    <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_key_path</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:output_fmt</span><span class='rbracket'>]</span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>private_key</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id open'>open</span><span class='lparen'>(</span><span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wb</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id file'>file</span><span class='op'>|</span>
      <span class='id file'>file</span><span class='period'>.</span><span class='id chmod'>chmod</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:signing_key</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id file'>file</span><span class='period'>.</span><span class='id write'>write</span><span class='lparen'>(</span><span class='id key'>key</span><span class='period'>.</span><span class='id to_pem'>to_pem</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># build self-signed public cert from key
</span>  <span class='id cert'>cert</span> <span class='op'>=</span> <span class='id build_cert'>build_cert</span><span class='lparen'>(</span><span class='id name'>name</span><span class='comma'>,</span> <span class='id key'>key</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># if we're saving the cert, then write it out
</span>  <span class='kw'>if</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_cert</span><span class='rbracket'>]</span>
    <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:cert</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_cert_path</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:output_fmt</span><span class='rbracket'>]</span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>public_cert</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id open'>open</span><span class='lparen'>(</span><span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:cert</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wb</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id file'>file</span><span class='op'>|</span>
      <span class='id file'>file</span><span class='period'>.</span><span class='id chmod'>chmod</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:signing_cert</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id file'>file</span><span class='period'>.</span><span class='id write'>write</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='period'>.</span><span class='id to_pem'>to_pem</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># return key, cert, and paths (if applicable)
</span>  <span class='lbrace'>{</span> <span class='symbol'>:key</span> <span class='op'>=&gt;</span> <span class='id key'>key</span><span class='comma'>,</span> <span class='symbol'>:cert</span> <span class='op'>=&gt;</span> <span class='id cert'>cert</span><span class='comma'>,</span>
    <span class='symbol'>:key_path</span> <span class='op'>=&gt;</span> <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:cert_path</span> <span class='op'>=&gt;</span> <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:cert</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="sign_cert-class_method">
  
    + (<tt>Object</tt>) <strong>sign_cert</strong>(cert, signing_key, signing_cert, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Sign the cert cert with @signing_key and @signing_cert, using the digest
algorithm opt[:dgst_algo]. Returns the newly signed certificate.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


636
637
638
639
640
641
642
643
644</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 636</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id sign_cert'>sign_cert</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='comma'>,</span> <span class='id signing_key'>signing_key</span><span class='comma'>,</span> <span class='id signing_cert'>signing_cert</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># set up issuer information
</span>  <span class='id cert'>cert</span><span class='period'>.</span><span class='id issuer'>issuer</span> <span class='op'>=</span> <span class='id signing_cert'>signing_cert</span><span class='period'>.</span><span class='id subject'>subject</span>
  <span class='id cert'>cert</span><span class='period'>.</span><span class='id sign'>sign</span><span class='lparen'>(</span><span class='id signing_key'>signing_key</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:dgst_algo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id new'>new</span><span class='rparen'>)</span>

  <span class='id cert'>cert</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="verify_trust_dir-class_method">
  
    + (<tt>Object</tt>) <strong>verify_trust_dir</strong>(path, perms) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Make sure the trust directory exists.  If it does exist, make sure
it&#8217;s actually a directory.  If not, then create it with the
appropriate permissions.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


651
652
653
654
655
656
657
658
659
660
661
662
663
664
665</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 651</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id verify_trust_dir'>verify_trust_dir</span><span class='lparen'>(</span><span class='id path'>path</span><span class='comma'>,</span> <span class='id perms'>perms</span><span class='rparen'>)</span>
  <span class='comment'># if the directory exists, then make sure it is in fact a directory.  if
</span>  <span class='comment'># it doesn't exist, then create it with the appropriate permissions
</span>  <span class='kw'>if</span> <span class='const'>File</span><span class='period'>.</span><span class='id exist?'>exist?</span><span class='lparen'>(</span><span class='id path'>path</span><span class='rparen'>)</span>
    <span class='comment'># verify that the trust directory is actually a directory
</span>    <span class='kw'>unless</span> <span class='const'>File</span><span class='period'>.</span><span class='id directory?'>directory?</span><span class='lparen'>(</span><span class='id path'>path</span><span class='rparen'>)</span>
      <span class='id err'>err</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>trust directory </span><span class='embexpr_beg'>#{</span><span class='id path'>path</span><span class='rbrace'>}</span><span class='tstring_content'> isn't a directory</span><span class='tstring_end'>&quot;</span></span>
      <span class='id raise'>raise</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>Security</span><span class='op'>::</span><span class='const'>Exception</span><span class='comma'>,</span> <span class='id err'>err</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='comment'># trust directory doesn't exist, so create it with permissions
</span>    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id mkdir_p'>mkdir_p</span><span class='lparen'>(</span><span class='id path'>path</span><span class='rparen'>)</span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id chmod'>chmod</span><span class='lparen'>(</span><span class='id perms'>perms</span><span class='comma'>,</span> <span class='id path'>path</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Mon May 16 15:53:32 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.8 (ruby-1.9.2).
</div>

  </body>
</html>